<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

</head>

<body style="font-family:sans-serif;padding:20px">

<h1 style="text-align:center">ğŸ¤ à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©</h1>

<hr>

<h2>ğŸ‘¤ à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¸—à¸³à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸š</h2>

<input id="studentName" placeholder="à¸Šà¸·à¹ˆà¸­à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™"
       style="padding:8px;font-size:16px;width:220px">
<br><br>

<h3 id="word"></h3>

<button id="recordBtn">ğŸ™ï¸ à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡</button>
<button id="stopBtn" disabled>â¹ï¸ à¸«à¸¢à¸¸à¸”</button>
<button id="uploadBtn" disabled>â˜ï¸ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸µà¸¢à¸‡</button>
<button id="nextBtn">â¡ï¸ à¸‚à¹‰à¸­à¸–à¸±à¸”à¹„à¸›</button>

<br><br>
<button id="checkBtn">ğŸ¤– à¸•à¸£à¸§à¸ˆà¸à¸²à¸£à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡ (AI)</button>

<p id="status"></p>
<p id="aiResult"></p>

<audio id="player" controls></audio>

<hr>

<h2>ğŸ§ à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸£à¸¹ / à¸œà¸¹à¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™</h2>
<button id="loadAdmin">ğŸ“‚ à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸µà¸¢à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
<div id="adminList"></div>

<script>
// ================= à¸„à¸³à¸¨à¸±à¸à¸—à¹Œ =================
const words = [
  "Colonel",
  "Queue",
  "Iron",
  "Salmon",
  "Choir",
  "Cough",
  "Enough",
  "Height",
  "Comfortable",
  "Schedule"
];

let current = 0;
const wordEl = document.getElementById("word");
wordEl.innerHTML = `à¸„à¸³à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸­à¹ˆà¸²à¸™: <b>${words[current]}</b>`;

// ================= Firebase =================

const firebaseConfig = {
  apiKey: "AIzaSyCrrQakS5d6r3Iv3c4nDV9Fra5V8SUEzxo",
  authDomain: "sirichai-f418d.firebaseapp.com",
  projectId: "sirichai-f418d",
  storageBucket: "sirichai-f418d.firebasestorage.app",
  messagingSenderId: "516886168978",
  appId: "1:516886168978:web:5ed52810210763ab492d4b",
  measurementId: "G-L1H1WBJZBJ"
};

firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

// ================= à¸•à¸±à¸§à¹à¸›à¸£ =================
let recorder, audioBlob;
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const uploadBtn = document.getElementById("uploadBtn");
const nextBtn = document.getElementById("nextBtn");
const status = document.getElementById("status");
const player = document.getElementById("player");

// ================= à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡ =================
recordBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  recorder = new MediaRecorder(stream);
  let chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    audioBlob = new Blob(chunks, { type:"audio/webm" });
    player.src = URL.createObjectURL(audioBlob);
    uploadBtn.disabled = false;
  };

  recorder.start();
  status.innerText = "ğŸ”´ à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡...";
  recordBtn.disabled = true;
  stopBtn.disabled = false;
};

// ================= à¸«à¸¢à¸¸à¸” =================
stopBtn.onclick = () => {
  recorder.stop();
  status.innerText = "âœ… à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸ªà¸£à¹‡à¸ˆ";
  recordBtn.disabled = false;
  stopBtn.disabled = true;
};

// ================= à¸­à¸±à¸›à¹‚à¸«à¸¥à¸” Firebase =================
uploadBtn.onclick = async () => {
  const name = document.getElementById("studentName").value.trim();
  if (!name) {
    alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™");
    return;
  }

  const word = words[current];
  const filename = `à¹€à¸ªà¸µà¸¢à¸‡/${name}/${word}_${Date.now()}.webm`;
  const ref = storage.ref(filename);

  await ref.put(audioBlob);
  status.innerText = `â˜ï¸ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸µà¸¢à¸‡à¸„à¸³ "${word}" à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`;
  uploadBtn.disabled = true;
};

// ================= à¸‚à¹‰à¸­à¸–à¸±à¸”à¹„à¸› =================
nextBtn.onclick = () => {
  current++;
  player.src = "";
  uploadBtn.disabled = true;
  document.getElementById("aiResult").innerText = "";

  if (current < words.length) {
    wordEl.innerHTML = `à¸„à¸³à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸­à¹ˆà¸²à¸™: <b>${words[current]}</b>`;
    status.innerText = "";
  } else {
    wordEl.innerHTML = "ğŸ‰ à¸—à¸³à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸„à¸£à¸šà¸—à¸¸à¸à¸„à¸³à¹à¸¥à¹‰à¸§";
    recordBtn.disabled = true;
    stopBtn.disabled = true;
    uploadBtn.disabled = true;
  }
};

// ================= AI à¸•à¸£à¸§à¸ˆà¸à¸²à¸£à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡ =================
document.getElementById("checkBtn").onclick = () => {
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("à¹€à¸šà¸£à¸²à¹€à¸‹à¸­à¸£à¹Œà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š AI à¸•à¸£à¸§à¸ˆà¹€à¸ªà¸µà¸¢à¸‡");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.start();

  const aiResult = document.getElementById("aiResult");
  aiResult.innerText = "ğŸ¤– AI à¸à¸³à¸¥à¸±à¸‡à¸Ÿà¸±à¸‡...";

  recognition.onresult = (event) => {
    const spoken = event.results[0][0].transcript.toLowerCase();
    const correct = words[current].toLowerCase();

    let score = 0;
    let resultText = "";

    if (spoken === correct) {
      score = 100;
      resultText = "âœ… à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡";
    } else if (spoken.includes(correct) || correct.includes(spoken)) {
      score = 70;
      resultText = "âš ï¸ à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡";
    } else {
      score = 30;
      resultText = "âŒ à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡à¹„à¸¡à¹ˆà¸•à¸£à¸‡";
    }

    aiResult.innerHTML = `
      à¹„à¸”à¹‰à¸¢à¸´à¸™à¸§à¹ˆà¸²: <b>${spoken}</b><br>
      à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ: ${resultText}<br>
      à¸„à¸°à¹à¸™à¸™: <b>${score}/100</b>
    `;
  };

  recognition.onerror = () => {
    aiResult.innerText = "âŒ AI à¸Ÿà¸±à¸‡à¹„à¸¡à¹ˆà¸Šà¸±à¸” à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ";
  };
};

// ================= à¹à¸­à¸”à¸¡à¸´à¸™à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ =================
document.getElementById("loadAdmin").onclick = () => {
  const adminList = document.getElementById("adminList");
  adminList.innerHTML = "";

  storage.ref("à¹€à¸ªà¸µà¸¢à¸‡").listAll().then(res => {
    res.prefixes.forEach(folder => {
      const h3 = document.createElement("h3");
      h3.innerText = "ğŸ‘¤ " + folder.name;
      adminList.appendChild(h3);

      folder.listAll().then(files => {
        files.items.forEach(file => {
          file.getDownloadURL().then(url => {
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.src = url;
            adminList.appendChild(audio);
            adminList.appendChild(document.createElement("br"));
          });
        });
      });
    });
  });
};
</script>

</body>
</html>